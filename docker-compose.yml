services:
  stats-db:
    image: postgres:16.1
    container_name: postgres-ewm-stats-db
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=statsdb
      - POSTGRES_USER=dbuser
      - POSTGRES_PASSWORD=123456
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dbuser -d statsdb"]
      timeout: 5s
      interval: 5s
      retries: 10

  users-db:
    image: postgres:16.1
    container_name: postgres-ewm-users-db
    ports:
      - "5430:5432"
    environment:
      - POSTGRES_DB=users-db
      - POSTGRES_USER=dbuser
      - POSTGRES_PASSWORD=123456
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dbuser -d users-db"]
      timeout: 5s
      interval: 5s
      retries: 10

  locations-db:
    image: postgres:16.1
    container_name: postgres-ewm-locations-db
    ports:
      - "5431:5432"
    environment:
      - POSTGRES_DB=locations-db
      - POSTGRES_USER=dbuser
      - POSTGRES_PASSWORD=123456
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dbuser -d locations-db"]
      timeout: 5s
      interval: 5s
      retries: 10

  requests-db:
    image: postgres:16.1
    container_name: postgres-ewm-requests-db
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_DB=requests-db
      - POSTGRES_USER=dbuser
      - POSTGRES_PASSWORD=123456
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dbuser -d requests-db"]
      timeout: 5s
      interval: 5s
      retries: 10

  events-db:
    image: postgres:16.1
    container_name: postgres-ewm-events-db
    ports:
      - "5434:5432"
    environment:
      - POSTGRES_DB=events-db
      - POSTGRES_USER=dbuser
      - POSTGRES_PASSWORD=123456
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dbuser -d events-db"]
      timeout: 5s
      interval: 5s
      retries: 10

  # Eureka Server для service discovery
  discovery-server:
    ports:
      - "8761:8761"
    build:
      context: ./infra/discovery-server
      dockerfile: Dockerfile
    image: discovery-server
    container_name: discovery-server
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8761/actuator/health" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # Config Server (если используется)
  config-server:
    ports:
      - "8888:8888"
    build:
      context: ./infra/config-server
      dockerfile: Dockerfile
    image: config-server
    container_name: config-server
    depends_on:
      discovery-server:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8888/actuator/health" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka

  # Gateway Server
  gateway-server:
    ports:
      - "8080:8080"
    build:
      context: ./infra/gateway-server
      dockerfile: Dockerfile
    image: gateway-server
    container_name: gateway-server
    depends_on:
      discovery-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka
      - SPRING_CLOUD_CONFIG_URI=http://config-server:8888
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8888

  # Сервис статистики
  stats-server:
    ports:
      - "8080"
    build:
      context: ./stats/stats-server
      dockerfile: Dockerfile
    image: stats-server
    container_name: stats-server
    depends_on:
      stats-db:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://stats-db:5432/statsdb
      - SPRING_DATASOURCE_USERNAME=dbuser
      - SPRING_DATASOURCE_PASSWORD=123456
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka
      - SPRING_CLOUD_CONFIG_URI=http://config-server:8888
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8888
      - SPRING_CLOUD_CONFIG_FAIL_FAST=false
      - SPRING_CLOUD_CONFIG_RETRY_INITIAL_INTERVAL=2000
      - SPRING_CLOUD_CONFIG_RETRY_MAX_ATTEMPTS=10

  # Сервис пользователей
  user-service:
    ports:
      - "8080"
    build:
      context: ./core/user-service
      dockerfile: Dockerfile
    image: user-service
    container_name: user-service
    depends_on:
      users-db:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://users-db:5432/users-db
      - SPRING_DATASOURCE_USERNAME=dbuser
      - SPRING_DATASOURCE_PASSWORD=123456
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka
      - SPRING_CLOUD_CONFIG_URI=http://config-server:8888
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8888
      - SPRING_CLOUD_CONFIG_FAIL_FAST=false
      - SPRING_CLOUD_CONFIG_RETRY_INITIAL_INTERVAL=2000
      - SPRING_CLOUD_CONFIG_RETRY_MAX_ATTEMPTS=10

  # Сервис локаций
  location-service:
    ports:
      - "8080"
    build:
      context: ./core/location-service
      dockerfile: Dockerfile
    image: location-service
    container_name: location-service
    depends_on:
      locations-db:
        condition: service_healthy
      config-server:
        condition: service_healthy
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://locations-db:5432/locations-db
      - SPRING_DATASOURCE_USERNAME=dbuser
      - SPRING_DATASOURCE_PASSWORD=123456
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka
      - SPRING_CLOUD_CONFIG_URI=http://config-server:8888
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8888
      - SPRING_CLOUD_CONFIG_FAIL_FAST=false
      - SPRING_CLOUD_CONFIG_RETRY_INITIAL_INTERVAL=2000
      - SPRING_CLOUD_CONFIG_RETRY_MAX_ATTEMPTS=10

  # Сервис запросов на участие
  request-service:
    ports:
      - "8080"
    build:
      context: ./core/request-service
      dockerfile: Dockerfile
    image: request-service
    container_name: request-service
    depends_on:
      requests-db:
        condition: service_healthy
      config-server:
        condition: service_healthy
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://requests-db:5432/requests-db
      - SPRING_DATASOURCE_USERNAME=dbuser
      - SPRING_DATASOURCE_PASSWORD=123456
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka
      - SPRING_CLOUD_CONFIG_URI=http://config-server:8888
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8888
      - SPRING_CLOUD_CONFIG_FAIL_FAST=false
      - SPRING_CLOUD_CONFIG_RETRY_INITIAL_INTERVAL=2000
      - SPRING_CLOUD_CONFIG_RETRY_MAX_ATTEMPTS=10

# Сервис событий
  event-service:
    ports:
      - "8080"
    build:
      context: ./core/event-service
      dockerfile: Dockerfile
    image: event-service
    container_name: event-service
    depends_on:
      events-db:
        condition: service_healthy
      config-server:
        condition: service_healthy
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://events-db:5432/events-db
      - SPRING_DATASOURCE_USERNAME=dbuser
      - SPRING_DATASOURCE_PASSWORD=123456
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka
      - SPRING_CLOUD_CONFIG_URI=http://config-server:8888
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8888
      - SPRING_CLOUD_CONFIG_FAIL_FAST=false
      - SPRING_CLOUD_CONFIG_RETRY_INITIAL_INTERVAL=2000
      - SPRING_CLOUD_CONFIG_RETRY_MAX_ATTEMPTS=10
